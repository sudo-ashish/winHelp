# Architecture

> Auto-generated by /map on 2026-02-22

## Overview

**winHelp** is a modular PowerShell-based Windows setup automation toolkit. Its purpose is to fully provision a fresh Windows installation: installing apps via winget, configuring Git/GitHub, applying system tweaks, removing bloatware, setting up editor environments (Neovim, VSCodium, Antigravity), and deploying a developer PowerShell profile.

The project is organized into two tiers:
- **`eg-bak/`** — Reference module scripts (the canonical implementation logic)
- **`asset-bak/`** — Reference asset files (configs, profiles, JSON settings deployed to target system)

```
┌──────────────────────────────────────────────────┐
│               Entry Point (TBD)                  │
│              install-win.ps1 (orchestrator)       │
├──────────────────────────────────────────────────┤
│   App Manager  │  Debloater  │  Git/GitHub Mgr   │
│  install-win   │  debloater  │  Git.ps1           │
│                │             │  GitHub.ps1        │
├──────────────────────────────────────────────────┤
│  Terminal Cfg  │  Backup/    │  Validation Suite  │
│  merge-terminl │  Restore    │  scripts/          │
│                │  Backups    │                    │
├──────────────────────────────────────────────────┤
│         Asset Layer (asset-bak/)                 │
│  powershell-profile.ps1  │  wt-defaults.json     │
│  nvim/init.lua + plugins │  codium/settings.json │
│  antigravity/settings.json                       │
└──────────────────────────────────────────────────┘
         ↓ external integrations
   winget · GitHub CLI (gh) · PSGallery · Windows Registry
```

---

## Components

### App Manager (`eg-bak/install-win.ps1`)
- **Purpose:** Defines ~30 application entries with winget/msstore IDs; installs them via `winget install` with silent flags
- **Location:** `eg-bak/install-win.ps1`
- **Key exports:** `$Global:AppDefinitions`, `Invoke-AppInstall`
- **Dependencies:** `winget`, `$Global:Config`, `Write-Log`
- **Pattern:** Config-driven — reads `modules.software.default_apps` from global config

### Debloater (`eg-bak/debloater.ps1`)
- **Purpose:** Removes Windows bloatware AppX packages, disables telemetry services, disables Bing search, applies registry tweaks from `assets/tweak.json`
- **Location:** `eg-bak/debloater.ps1`
- **Key exports:** `Invoke-Debloat`, `Disable-Telemetry`, `Remove-Bloatware`, `Disable-BingSearch`
- **Dependencies:** `$Global:Config.modules.debloat`, `$Global:AppRoot`, `Write-Log`
- **Pattern:** Admin-privilege-aware; reads JSON tweak file from assets directory

### Git Configurator (`eg-bak/git/Git.ps1`)
- **Purpose:** Sets global git `user.name` / `user.email` from config; installs `gh` CLI and `fzf` via winget
- **Location:** `eg-bak/git/Git.ps1`
- **Key exports:** `Set-GitConfig`, `Install-Tools`
- **Dependencies:** `$Global:Config.settings.user`, `winget`, `Write-Log`

### GitHub Manager (`eg-bak/git/GitHub.ps1`)
- **Purpose:** Authenticates via GitHub CLI, lists all repos, clones selected repos to local target path
- **Location:** `eg-bak/git/GitHub.ps1`
- **Key exports:** `Invoke-GitHubFetch`, `Invoke-GitHubClone`, `Invoke-GitHubRepos`
- **Dependencies:** `gh` CLI, `$Global:Config.modules.github`, `Write-Log`
- **Pattern:** `auto_clone` config gate; clone destination `$HOME\Documents\github-repo`

### Terminal Configurator (`eg-bak/merge-terminl.ps1`)
- **Purpose:** Deep-merges `assets/wt-defaults.json` into Windows Terminal's live `settings.json`
- **Location:** `eg-bak/merge-terminl.ps1`
- **Key exports:** `Set-TerminalDefaults`
- **Dependencies:** `$Global:AppRoot`, `Write-Log`; Windows Terminal must be installed

### Backup & Restore (`eg-bak/Backups.ps1`)
- **Purpose:** Exports/imports Windows Registry hives (themes, explorer, mouse, touchpad) and PowerShell profile to/from dated snapshot folders
- **Location:** `eg-bak/Backups.ps1`
- **Key exports:** `Invoke-Backup`, `Invoke-Restore`
- **Dependencies:** `$Global:AppRoot`, `reg.exe`, `Write-Log`
- **Snapshots:** `build/snapshots/YYYY-MM-DD[-N]-restorepoint/`

### PowerShell Profile (`asset-bak/powershell-profile.ps1`)
- **Purpose:** Developer shell environment — auto-installs oh-my-posh, zoxide, Terminal-Icons, PSReadLine; provides aliases and functions for file ops, git, networking, process management
- **Location:** `asset-bak/powershell-profile.ps1`
- **Key exports:** 40+ functions and aliases (`lazyg`, `la`, `ll`, `mkcd`, `rmrf`, `touch`, `ff`, `pkill`, `myip`, `pubip`, `gs`, `gc`, etc.)
- **Dependencies:** `winget`, PSGallery, oh-my-posh, zoxide

### Validation Suite (`scripts/`)
- **Purpose:** GSD meta-validators that check .agent/ structure integrity (workflows YAML, skill SKILL.md files, templates)
- **Location:** `scripts/validate-*.ps1` / `scripts/validate-all.ps1`
- **Key exports:** `validate-all.ps1` runs all three validators and exits 0/1

### Asset Configs (`asset-bak/`)
- **`wt-defaults.json`** — Windows Terminal profile defaults (font: JetBrainsMonoNL NF 16px, opacity 80, acrylic off)
- **`nvim/init.lua`** — Minimal Neovim config (line numbers, relative numbers, system clipboard)
- **`nvim/plugin/`** — Neovim plugin configs (4 plugin files)
- **`codium/settings.json`** — VSCodium editor settings
- **`antigravity/settings.json`** — Antigravity editor settings
- **`ide-extension.txt`** — VSCodium + Antigravity extension lists (7 each)

---

## Data Flow

1. **Orchestrator** loads `$Global:Config` (JSON config file) and sets `$Global:AppRoot`
2. **Module functions** are dot-sourced or called from orchestrator
3. **App installs** → `winget install` with ID + source from `$AppDefinitions`
4. **Debloat** → reads `assets/tweak.json` → applies registry changes via `Set-ItemProperty`
5. **Git setup** → writes to `~/.gitconfig` via `git config --global`
6. **GitHub** → `gh api` + `gh repo list` → `git clone` to local target
7. **Terminal** → JSON merge to `%LOCALAPPDATA%\…\settings.json`
8. **Backup** → `reg export` to `build/snapshots/` folder
9. **Profile deploy** → copy `asset-bak/powershell-profile.ps1` to `$PROFILE`

---

## Integration Points

| External Service | Type | Purpose |
|------------------|------|---------|
| `winget` | CLI tool | Install apps and CLI binaries |
| GitHub CLI (`gh`) | CLI tool | Auth + repo listing/cloning |
| PSGallery | Module registry | Install Terminal-Icons, PSReadLine |
| Windows Registry | OS API | Tweak application via `reg.exe` / PowerShell |
| GitHub API | REST (via `gh`) | Fetch repo metadata |
| oh-my-posh CDN | HTTP | Download prompt theme at shell init |

---

## Conventions

- **Naming:** `Verb-Noun` PascalCase for all functions (`Invoke-Debloat`, `Set-GitConfig`)
- **Logging:** `Write-Log "..." -Level INFO|WARN|ERROR|DEBUG` — shared logging function (defined in orchestrator, not yet in reference)
- **Config:** `$Global:Config` — single global JSON config object; module-specific settings under `$Global:Config.modules.<name>`
- **AppRoot:** `$Global:AppRoot` — root path of the installation; all asset paths are relative to it
- **Structure:** Reference scripts in `eg-bak/`, reference assets in `asset-bak/`; produced output goes to `build/`

---

## Technical Debt

- [ ] **No orchestrator script exists yet** — `eg-bak/install-win.ps1` is the app-install fragment, not a full orchestrator; the main entry point that wires all modules together is missing
- [ ] **`Write-Log` undefined in fragments** — logging function referenced everywhere but not defined in any reference script (must be in a not-yet-created logger module)
- [ ] **`$Global:Config` loading unspecified** — no config loader or `config.json` schema file exists in the project
- [ ] **`assets/tweak.json` missing** — `debloater.ps1` reads `$Global:AppRoot/assets/tweak.json` but no such file exists in repo
- [ ] **Duplicate bloatware entries** — `Microsoft.BingNews` and `Microsoft.BingWeather` appear twice in `Remove-Bloatware` list
- [ ] **`merge-terminl.ps1` typo in filename** — should be `merge-terminal.ps1`
- [ ] **No install sequence / dependency ordering** — e.g., Git must install before GitHub module runs; gh must install before `Invoke-GitHubFetch`
- [ ] **No error recovery / rollback** — individual module failures don't halt execution or trigger restore
